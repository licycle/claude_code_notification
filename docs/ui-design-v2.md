# Claude Monitor UI 设计方案 v2

## 设计理念

三级渐进式提示系统，从强到弱：

| 级别 | 实现技术 | 用途 | 信息密度 |
|-----|---------|------|---------|
| **一级** | 系统通知 (UserNotifications) | 入侵式强提示 | 精简 (~150字) |
| **二级** | NSStatusItem + NSPopover | 菜单栏展开 | 丰富 (详情+时间线) |
| **三级** | NSWindow 管理应用 | 完整功能 | 全部 (报告+设置) |

---

## 一级：系统通知 (System Notification)

### 技术实现
- 使用 `UserNotifications` 框架
- Alert 模式（不自动消失，需用户操作）
- 最多 2 个操作按钮

### 字符限制
| 字段 | 限制 | 用途 |
|-----|------|------|
| title | ~35 字符 | 状态 + 账号 + session_id |
| subtitle | ~35 字符 | 任务摘要(raw模式:用户当前轮输入) + 轮数 |
| body | ~80 字符 | 关键信息/问题(raw模式:claude返回信息) |

### 触发条件
| Hook 事件 | 通知类型 |
|----------|---------|
| `Stop` + idle_prompt | 任务空闲 |
| `Stop` + elicitation_dialog | 需要决策 |
| `Notification` + permission_prompt | 权限确认 |
| `PostToolUse` + AskUserQuestion | 需要决策 |
| 任务完成 (all todos done) | 任务完成 |

### 通知样式

#### 1. 需要决策
```
┌────────────────────────────────────────────┐
│ ⚠️ 需要决策 [personal][5f95]                      │
│ 重构认证模块 · 7                         │
│ 选择 OAuth 库: passport / oauth4webapi     │
│                      [跳转终端] [忽略]      │
└────────────────────────────────────────────┘
```

#### 2. 任务空闲
```
┌────────────────────────────────────────────┐
│ 💤 Claude 空闲 [work][abc1]                 │
│ 修复登录 Bug · 4                            │
│ 添加错误处理逻辑                            │
│                      [跳转终端] [忽略]      │
└────────────────────────────────────────────┘
```

#### 3. 权限确认
```
┌────────────────────────────────────────────┐
│ 🔐 权限确认 [personal][5f95]                │
│ 重构认证模块 · 7                            │
│ 请求执行: rm -rf node_modules              │
│                      [跳转终端] [忽略]      │
└────────────────────────────────────────────┘
```

#### 4. 任务完成
```
┌────────────────────────────────────────────┐
│ ✅ 任务完成 [work][abc1]                    │
│ 修复登录 Bug · 6                            │
│ 已完成全部步骤                              │
│                      [跳转终端] [忽略]      │
└────────────────────────────────────────────┘
```

### 内容格式规范
```
title:    {emoji} {状态} [{账号}][{session_id}]  (~35字)
subtitle: {任务摘要} · {轮数}                    (~35字)
body:     {关键信息/问题/下一步}                 (~80字)
```

### 交互行为
- **点击通知**：跳转到对应终端窗口
- **跳转终端按钮**：激活终端并置顶
- **忽略按钮**：关闭通知

---

## 二级：状态小组件 (Status Widget)

### 技术实现
- **菜单栏图标**：NSStatusItem
- **弹出面板**：NSPopover
- **可选**：WidgetKit 通知中心小组件

### 菜单栏图标

```
┌──────────────────────────────────────────────────────────────┐
│  其他图标...  │ 🔵 3 │  时钟                                 │
└───────────────┴──┬───┴───────────────────────────────────────┘
                   │ 点击展开
                   ▼
```

**图标状态**：
- 🔴 红点 + 数字：有任务需要决策
- 🟡 黄点 + 数字：有任务空闲中
- 🟢 绿点 + 数字：所有任务正常运行
- ⚪ 灰点：无活动任务

### Popover 任务列表 (360x480)

```
┌────────────────────────────────────────────────────────────┐
│  Claude Monitor                              [⚙️] [➕]      │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  ┌────────────────────────────────────────────────────┐    │
│  │ 🔴 重构认证模块                    personal         │    │
│  │    ━━━━━━━━━━━━━━━━░░░░░░ 70%                       │    │
│  │    ⚠️ 等待决策: OAuth 库选择                        │    │
│  │    ⏱️ 2分钟前                                       │    │
│  └────────────────────────────────────────────────────┘    │
│                                                            │
│  ┌────────────────────────────────────────────────────┐    │
│  │ 🟢 修复登录 Bug                    work             │    │
│  │    ━━━━━━━━━━━━━━━━━━━━━━━━━━ 100%                  │    │
│  │    ✅ 已完成                                        │    │
│  │    ⏱️ 5分钟前                                       │    │
│  └────────────────────────────────────────────────────┘    │
│                                                            │
│  ┌────────────────────────────────────────────────────┐    │
│  │ 🟡 添加用户头像功能                personal         │    │
│  │    ━━━━━━━━━━━━░░░░░░░░░░░ 50%                      │    │
│  │    💤 空闲中                                        │    │
│  │    ⏱️ 10分钟前                                      │    │
│  └────────────────────────────────────────────────────┘    │
│                                                            │
├────────────────────────────────────────────────────────────┤
│  [ 🗑️ 清除已完成 ]                    [ 📊 查看报告 ]      │
└────────────────────────────────────────────────────────────┘
```

### 任务详情页（点击任务卡片展开）

```
┌────────────────────────────────────────────────────────────┐
│  ← 返回                      重构认证模块                   │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  🎯 原始目标                                               │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 重构现有认证模块，支持 OAuth2.0 和 SSO                │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                            │
│  📊 进度时间线                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ ● 14:30  开始任务                                     │  │
│  │ │        分析现有代码结构                             │  │
│  │ │                                                     │  │
│  │ ● 14:45  完成分析阶段                                 │  │
│  │ │        创建 OAuth 服务基础类                        │  │
│  │ │                                                     │  │
│  │ ● 15:02  核心逻辑完成                                 │  │
│  │ │        OAuth flow 实现完成                          │  │
│  │ │                                                     │  │
│  │ ◐ 15:15  等待决策                         ← 当前      │  │
│  │          需要选择 OAuth 库                            │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                            │
│  ✅ 已完成 (7)                                             │
│  • 分析认证模块现有结构                                    │
│  • 设计 OAuth2.0 集成方案                                  │
│  • 创建 OAuthService 基础类                                │
│  • 实现 token 存储机制                                     │
│  • ...更多                                                 │
│                                                            │
│  ⏳ 待完成 (3)                                             │
│  • 选择并集成 OAuth 库                                     │
│  • 实现 SSO 支持                                           │
│  • 更新文档                                                │
│                                                            │
├────────────────────────────────────────────────────────────┤
│  [ 🚀 跳转终端 ]    [ 📋 复制摘要 ]    [ 🗑️ 结束任务 ]      │
└────────────────────────────────────────────────────────────┘
```

### WidgetKit 小组件（可选）

通知中心侧边栏，3 种尺寸：

#### Small (158x158)
```
┌────────────────────┐
│ Claude Monitor     │
│                    │
│    🔴 3 任务       │
│    需要关注        │
│                    │
└────────────────────┘
```

#### Medium (338x158)
```
┌─────────────────────────────────────────┐
│ Claude Monitor                          │
│                                         │
│ 🔴 重构认证   70%  ⚠️ 等待决策          │
│ 🟢 修复Bug   100%  ✅ 完成              │
│ 🟡 添加头像   50%  💤 空闲              │
│                                         │
└─────────────────────────────────────────┘
```

---

## 三级：管理应用 (Management App)

### 功能模块

#### 1. 任务中心 (Task Center)
- 所有会话列表（活跃/已完成/已归档）
- 搜索和筛选
- 批量操作

#### 2. 会话详情 (Session Detail)
- 完整时间线
- 所有快照
- 原始 transcript（可选）

#### 3. 报告与分析 (Reports)
- 日/周/月报告
- 任务完成统计
- 时间分布分析
- 效率趋势

#### 4. 设置 (Settings)
- **API 配置**
  - 摘要服务（DeepSeek/OpenRouter/Ollama）
  - Claude 会话配置
- **通知设置**
  - 声音选择
  - 免打扰时段
- **数据管理**
  - 导出数据
  - 清理历史

### 窗口布局 (900x600)

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Claude Monitor                                                    ⚙️   │
├──────────────┬──────────────────────────────────────────────────────────┤
│              │                                                          │
│  📋 任务     │  重构认证模块                              personal     │
│  ├ 活跃 (3)  │  ━━━━━━━━━━━━━━━━░░░░░░ 70%                              │
│  ├ 今日 (5)  │                                                          │
│  └ 已归档    │  🎯 目标                                                 │
│              │  重构现有认证模块，支持 OAuth2.0 和 SSO                  │
│  📊 报告     │                                                          │
│  ├ 今日      │  📊 时间线                                               │
│  ├ 本周      │  ● 14:30  开始任务                                       │
│  └ 本月      │  ● 14:45  完成分析阶段                                   │
│              │  ● 15:02  核心逻辑完成                                   │
│  ⚙️ 设置     │  ◐ 15:15  等待决策                                       │
│  ├ API       │                                                          │
│  ├ 通知      │  ✅ 已完成 (7)              ⏳ 待完成 (3)                 │
│  └ 数据      │  • 分析认证模块现有结构    • 选择OAuth库                 │
│              │  • 设计 OAuth2.0 方案      • 实现 SSO                    │
│              │  • 创建 OAuthService       • 更新文档                    │
│              │                                                          │
├──────────────┴──────────────────────────────────────────────────────────┤
│  [ 🚀 跳转终端 ]  [ 📋 复制摘要 ]  [ 📤 导出 ]  [ 🗑️ 结束任务 ]        │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 节点聚合逻辑

### 问题背景

当前 timeline 表记录所有原始事件，导致：
- `status_change` 事件过多（每次 Stop 都记录）
- 无法区分"有意义的暂停"和"无关中断"
- 无法直接用于 UI 展示

### 聚合规则

#### 显示为节点
| 条件 | 节点类型 | 说明 |
|-----|---------|------|
| `goal_set` 事件 | 🟢 开始 | 任务开始 |
| 连续完成 3+ 个 todo | 🔵 里程碑 | 阶段性完成 |
| 状态变为 `waiting_for_user` | 🟡 等待 | 需要用户决策 |
| 状态变为 `waiting_permission` | 🟠 权限 | 需要权限确认 |
| 有 AI 摘要的 snapshot | 🔵 快照 | 重要状态保存 |
| 所有 todo 完成 | ✅ 完成 | 任务完成 |

#### 不显示为节点
| 条件 | 原因 |
|-----|------|
| 单个 `progress_update` | 粒度太细 |
| 连续相同 `status_change` | 重复 |
| 间隔 < 30秒的状态变更 | 可能是抖动 |
| 无内容变化的 snapshot | 无意义 |

### 聚合函数设计

```python
def aggregate_timeline_nodes(session_id: str) -> List[Dict]:
    """
    将原始 timeline 事件聚合为有意义的节点

    返回格式:
    [
        {
            "time": "14:30",
            "type": "start",           # start/milestone/waiting/permission/snapshot/complete
            "title": "开始任务",
            "description": "分析现有代码结构",
            "status": "completed"      # completed/current/pending
        },
        ...
    ]
    """
    pass
```

### 实现优先级
1. **P0**: 基础聚合（合并重复事件）
2. **P1**: 智能聚合（识别里程碑）
3. **P2**: AI 摘要聚合（使用 summary_service）

---

## 数据流设计

```
                                    ┌─────────────────┐
                                    │   管理应用       │
                                    │  (三级-完整)     │
                                    └────────┬────────┘
                                             │ 读写
                                             ▼
┌──────────────┐    事件    ┌──────────────────────────┐    通知    ┌──────────────┐
│ Claude Code  │ ────────> │    SQLite 数据库          │ ────────> │   系统通知    │
│    Hooks     │           │  (sessions, progress,     │           │  (一级-精简)  │
└──────────────┘           │   snapshots, timeline)    │           └──────────────┘
                           └──────────────────────────┘
                                      │ 读取
                          ┌───────────┴───────────┐
                          ▼                       ▼
                   ┌──────────────┐        ┌──────────────┐
                   │  菜单栏组件   │        │  WidgetKit   │
                   │ (二级-丰富)   │        │  (可选)      │
                   └──────────────┘        └──────────────┘
```

---

## 当前实现状态

### 已完成 ✅

| 模块 | 状态 | 说明 |
|-----|------|------|
| 系统通知 | ✅ | 基础通知已实现 |
| 窗口恢复 | ✅ | CGWindowID + Accessibility |
| SQLite 数据库 | ✅ | 6 张表完整 |
| Python Hooks | ✅ | 4 个 hook 完整 |
| 摘要服务 | ✅ | 3 个 Provider |

### 待实现 📋

| 模块 | 优先级 | 说明 |
|-----|--------|------|
| 通知内容优化 | P0 | 按新格式规范 |
| 节点聚合逻辑 | P0 | database.py 添加函数 |
| 菜单栏图标 | P1 | NSStatusItem |
| Popover 面板 | P1 | NSPopover + SwiftUI |
| 任务详情页 | P1 | 时间线展示 |
| WidgetKit | P2 | 通知中心小组件 |
| 管理应用 | P3 | 完整窗口 |

---

## 实现计划

### Phase 1: 通知优化 + 节点聚合
- [ ] 更新通知内容格式
- [ ] 实现 `aggregate_timeline_nodes()` 函数
- [ ] 添加里程碑检测逻辑

### Phase 2: 菜单栏组件
- [ ] NSStatusItem 图标
- [ ] NSPopover 任务列表
- [ ] 任务详情页
- [ ] 数据绑定

### Phase 3: WidgetKit 小组件
- [ ] Widget Extension 创建
- [ ] Small/Medium 布局
- [ ] App Group 数据同步

### Phase 4: 管理应用
- [ ] 主窗口框架
- [ ] 任务中心
- [ ] 报告与分析
- [ ] 设置页面

---

## 技术栈

| 组件 | 技术 |
|-----|------|
| 系统通知 | UserNotifications |
| 菜单栏 | NSStatusItem + NSPopover |
| 小组件 | WidgetKit + SwiftUI |
| 管理应用 | NSWindow + SwiftUI |
| 数据存储 | SQLite |
| 进程通信 | App Group + UserDefaults |

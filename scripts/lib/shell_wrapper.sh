#!/bin/sh
# shell_wrapper.sh - Shell wrapper generator for Claude Monitor
# This file is sourced by install.sh

# ================= Shell Wrapper Generation =================

# Generate the shell wrapper configuration file
# Arguments: $1 = CONFIG_FILE, $2 = BINARY_PATH, $3 = API_MANAGER_SCRIPT, $4 = ACCOUNT_MANAGER_SCRIPT, $5 = BASE_DIR
generate_shell_wrapper() {
    local config_file="$1"
    local binary_path="$2"
    local api_manager="$3"
    local account_manager="$4"
    local base_dir="$5"

    cat << EOF > "$config_file"
# Claude Monitor Configuration
# Auto-generated by install.sh

_CLAUDE_MON_APP="$binary_path"
_CLAUDE_API_MANAGER="$api_manager"
_CLAUDE_ACCOUNT_MANAGER="$account_manager"
_CLAUDE_HOOKS_DIR="$base_dir"

# --- API Management Command ---
function claude-api() {
    python3 "\$_CLAUDE_API_MANAGER" "\$@"
}

# --- Account Management Command ---
function claude-ac() {
    python3 "\$_CLAUDE_ACCOUNT_MANAGER" "\$@"
    if [ "\$1" = "add" ] || [ "\$1" = "rm" ]; then
        echo "ðŸ’¡ Run: source ~/.zshrc to apply changes"
    fi
}

# --- Core Smart Wrapper ---
_claude_wrapper() {
    local account_alias="\$1"
    local config_path="\$2"
    shift 2

    # 1. Detect Window IMMEDIATELY (before any processing)
    local detected_info=\$("\$_CLAUDE_MON_APP" detect 2>/dev/null)
    local detected_bundle=\$(echo "\$detected_info" | cut -d'|' -f1)
    local detected_pid=\$(echo "\$detected_info" | cut -d'|' -f2)
    local detected_window_id=\$(echo "\$detected_info" | cut -d'|' -f3)

    # 2. Generate pending session ID (UUID)
    local pending_id=\$(uuidgen | tr '[:upper:]' '[:lower:]')

    # 3. Parse Arguments
    local -a claude_args
    local api_profile=""

    while [[ \$# -gt 0 ]]; do
        key="\$1"
        case \$key in
            --api)
                api_profile="\$2"
                shift 2
                ;;
            --api=*)
                api_profile="\${key#*=}"
                shift 1
                ;;
            *)
                claude_args+=("\$1")
                shift 1
                ;;
        esac
    done

    # 4. Execute in Subshell (API env isolation only)
    (
        if [ -n "\$api_profile" ]; then
            eval "\$(python3 "\$_CLAUDE_API_MANAGER" get-env "\$api_profile")"
            echo "ðŸš€ API Profile Active: \$api_profile"
        fi

        export CLAUDE_TERM_BUNDLE_ID="\${detected_bundle:-com.apple.Terminal}"
        export CLAUDE_TERM_PID="\${detected_pid:-0}"
        export CLAUDE_SHELL_PID="\$\$"
        export CLAUDE_CG_WINDOW_ID="\${detected_window_id:-0}"
        export CLAUDE_CONFIG_DIR="\$config_path"
        export CLAUDE_ACCOUNT_ALIAS="\$account_alias"
        export CLAUDE_PENDING_SESSION_ID="\$pending_id"

        # Create pending session BEFORE starting Claude (shows 'idle' in status bar)
        python3 "\$_CLAUDE_HOOKS_DIR/task_tracker/hooks/session_init.py" 2>/dev/null

        command claude "\${claude_args[@]}"
    )

    # 5. Cleanup on exit (handles ctrl+c and normal exit)
    # Pass pending_id as argument to only cleanup this specific session
    (set +m; python3 "\$_CLAUDE_HOOKS_DIR/task_tracker/hooks/session_cleanup.py" "\$pending_id" >/dev/null 2>&1 &)
}
EOF
}

# Append account aliases to config file
# Arguments: $1 = CONFIG_FILE, $2 = account_aliases (space-separated), $3 = account_paths (pipe-separated)
append_account_aliases() {
    local config_file="$1"
    local aliases="$2"
    local paths="$3"

    ACCOUNT_ALIASES="$aliases" \
    ACCOUNT_PATHS="$paths" \
    CONFIG_FILE="$config_file" \
    ACCOUNTS_JSON="$(dirname "$config_file")/accounts.json" \
    python3 << 'PYEOF'
import os
import json

aliases = os.environ.get('ACCOUNT_ALIASES', '').split()
paths = os.environ.get('ACCOUNT_PATHS', '').split('|')[1:]  # Skip first empty element
config_file = os.environ['CONFIG_FILE']
accounts_json = os.environ['ACCOUNTS_JSON']

if len(aliases) != len(paths):
    print(f"âŒ Mismatch: {len(aliases)} aliases vs {len(paths)} paths")
    exit(1)

# Build accounts dict
accounts = {}
for alias, path in zip(aliases, paths):
    if alias and path:
        accounts[alias] = path

# Write accounts.json
with open(accounts_json, 'w') as f:
    json.dump(accounts, f, indent=2)
print(f"âœ… Generated {accounts_json}")

# Append aliases to config.sh
with open(config_file, 'a') as f:
    f.write("\n# --- User Aliases ---\n")
    for alias, path in accounts.items():
        f.write(f'alias {alias}=\'_claude_wrapper "{alias}" "{path}"\'\n')
        print(f"   Registered: {alias}")

exit(0)
PYEOF
    return $?
}

# Update shell RC file with source command
# Arguments: $1 = CONFIG_FILE
update_shell_rc() {
    local config_file="$1"
    local rc_file="$HOME/.zshrc"

    [ -f "$HOME/.bashrc" ] && rc_file="$HOME/.bashrc"

    local source_cmd="source \"$config_file\""

    # Clean up any duplicate/malformed entries first
    if grep -q "Claude Monitor" "$rc_file" 2>/dev/null; then
        cecho "${YELLOW}[!] Cleaning up existing Claude Monitor entries...${NC}"
        grep -v "Claude Monitor" "$rc_file" | grep -v "$config_file" > "${rc_file}.tmp"
        mv "${rc_file}.tmp" "$rc_file"
    fi

    # Add fresh configuration if not present
    if ! grep -q "$config_file" "$rc_file" 2>/dev/null; then
        echo "" >> "$rc_file"
        echo "# Claude Monitor Hooks" >> "$rc_file"
        echo "$source_cmd" >> "$rc_file"
    fi
}

# Update shell wrapper while preserving existing aliases
# Used by --hooks-only mode
# Arguments: $1 = CONFIG_FILE
update_shell_wrapper_preserve_aliases() {
    local config_file="$1"

    if [ ! -f "$config_file" ]; then
        cecho "${YELLOW}âš ï¸ config.sh not found, run full install${NC}"
        return 1
    fi

    # Extract existing aliases from config.sh
    local existing_aliases
    existing_aliases=$(grep "^alias " "$config_file" 2>/dev/null || true)

    # Regenerate config.sh with updated wrapper
    cat << 'WRAPPER_EOF' > "$config_file"
# Claude Monitor Configuration
# Auto-generated by install.sh

_CLAUDE_MON_APP="$HOME/Applications/ClaudeMonitor.app/Contents/MacOS/ClaudeMonitor"
_CLAUDE_API_MANAGER="$HOME/.claude-hooks/api_manager.py"
_CLAUDE_ACCOUNT_MANAGER="$HOME/.claude-hooks/account_manager.py"
_CLAUDE_HOOKS_DIR="$HOME/.claude-hooks"

# --- API Management Command ---
function claude-api() {
    python3 "$_CLAUDE_API_MANAGER" "$@"
}

# --- Account Management Command ---
function claude-ac() {
    python3 "$_CLAUDE_ACCOUNT_MANAGER" "$@"
    if [ "$1" = "add" ] || [ "$1" = "rm" ]; then
        echo "ðŸ’¡ Run: source ~/.zshrc to apply changes"
    fi
}

# --- Core Smart Wrapper ---
_claude_wrapper() {
    local account_alias="$1"
    local config_path="$2"
    shift 2

    # 1. Detect Window IMMEDIATELY (before any processing)
    local detected_info=$("$_CLAUDE_MON_APP" detect 2>/dev/null)
    local detected_bundle=$(echo "$detected_info" | cut -d'|' -f1)
    local detected_pid=$(echo "$detected_info" | cut -d'|' -f2)
    local detected_window_id=$(echo "$detected_info" | cut -d'|' -f3)

    # 2. Generate pending session ID (UUID)
    local pending_id=$(uuidgen | tr '[:upper:]' '[:lower:]')

    # 3. Parse Arguments
    local -a claude_args
    local api_profile=""

    while [[ $# -gt 0 ]]; do
        key="$1"
        case $key in
            --api)
                api_profile="$2"
                shift 2
                ;;
            --api=*)
                api_profile="${key#*=}"
                shift 1
                ;;
            *)
                claude_args+=("$1")
                shift 1
                ;;
        esac
    done

    # 4. Execute in Subshell (API env isolation only)
    (
        if [ -n "$api_profile" ]; then
            eval "$(python3 "$_CLAUDE_API_MANAGER" get-env "$api_profile")"
            echo "ðŸš€ API Profile Active: $api_profile"
        fi

        export CLAUDE_TERM_BUNDLE_ID="${detected_bundle:-com.apple.Terminal}"
        export CLAUDE_TERM_PID="${detected_pid:-0}"
        export CLAUDE_SHELL_PID="$$"
        export CLAUDE_CG_WINDOW_ID="${detected_window_id:-0}"
        export CLAUDE_CONFIG_DIR="$config_path"
        export CLAUDE_ACCOUNT_ALIAS="$account_alias"
        export CLAUDE_PENDING_SESSION_ID="$pending_id"

        # Create pending session BEFORE starting Claude (shows 'idle' in status bar)
        python3 "$_CLAUDE_HOOKS_DIR/task_tracker/hooks/session_init.py" 2>/dev/null

        command claude "${claude_args[@]}"
    )

    # 5. Cleanup on exit (handles ctrl+c and normal exit)
    # Pass pending_id as argument to only cleanup this specific session
    (set +m; python3 "$_CLAUDE_HOOKS_DIR/task_tracker/hooks/session_cleanup.py" "$pending_id" >/dev/null 2>&1 &)
}

# --- User Aliases ---
WRAPPER_EOF

    # Append existing aliases
    if [ -n "$existing_aliases" ]; then
        echo "$existing_aliases" >> "$config_file"
    fi

    cecho "${GREEN}âœ… Shell wrapper updated${NC}"
}
